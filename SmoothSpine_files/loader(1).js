(function(){function R(){return window.location.search.includes("jdgm_debug=true")}const b=R();function a(...e){b&&console.log(...e)}window.jdgm=window.jdgm||{},window.jdgm.debugLog=a;async function C(){const e=window.jdgm?.CDN_HOST,t=window.jdgm?.API_HOST,o=window.Shopify?.shop;if(!e){a("[Judge.me Widget Loader] CDN_HOST not configured, skipping CDN test");return}if(!o){a("[Judge.me Widget Loader] Shopify shop not found, skipping CDN test");return}const c=`${e}installed.js`;a("[Judge.me Widget Loader] Testing CDN reachability:",c);function d(s){if(a("[Judge.me Widget Loader] ‚ùå CDN test failed, reporting to API"),!t){a("[Judge.me Widget Loader] API_HOST not configured, cannot report CDN failure");return}const n=`${t}api/widget/requests`;fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({shop_domain:o,method:"GET",url:c,status:s,duration:0})}).then(()=>{a("[Judge.me Widget Loader] ‚úÖ CDN failure reported to API")}).catch(l=>{a("[Judge.me Widget Loader] ‚ö†Ô∏è Failed to report CDN failure:",l.message)})}const i=document.createElement("script");i.src=c;const r=setTimeout(()=>{d(0)},15e3);i.onload=()=>{clearTimeout(r),a("[Judge.me Widget Loader] ‚úÖ CDN test successful")},i.onerror=()=>{clearTimeout(r),d(-1)},document.head.appendChild(i)}C(),a("[Judge.me Widget Loader] Script loaded and executing...");const h=".jdgm-widget[data-entry-point]",w=document.querySelectorAll(h);if(w.length===0){a("[Judge.me Widget Loader] No containers found with selector:",h);return}a("[Judge.me Widget Loader] Found "+w.length+" container(s), processing each...");const L=new Set,g={REVIEW:"review",ALL_REVIEWS_V2025:"all-reviews-v2025",CAROUSEL:"carousel"},_={review:g.REVIEW,"all-reviews-v2025":g.ALL_REVIEWS_V2025,"testimonials-carousel":g.CAROUSEL,"cards-carousel":g.CAROUSEL};function D(e){const t=e.dataset.widget;return _[t]||null}function J(e){const t=e.querySelector(".jdgm-legacy-widget-content");return t?t.innerHTML.trim().length>20:!1}function I(e,t){if(t===g.ALL_REVIEWS_V2025){const d=window.jdgm?.data?.allReviewsWidgetV2025;return!!(d&&Object.keys(d).length>0)}const o=e.dataset.productId,c=window.jdgm?.data?.reviewWidget?.[o];return!!(c&&c.reviews!==void 0)}function v(e,t,o){const c=window.jdgmSettings?.[t],d=e.dataset.productId,i=J(e),r=I(e,o);let s=null,n="",l="",u=!1;return c?r?(u=!0,i?(s=1,n="Revamp enabled + both data sources available",l="Loading revamp widget (preferred)"):(s=3,n="Revamp enabled + only revamp data",l="Loading revamp widget (only option available)")):i?(s=2,n="Revamp enabled + only legacy data",l="Falling back to legacy widget (revamp data not available)",u=!1):(s="edge-revamp-no-data",n="Revamp enabled + no data sources",l="Loading revamp widget for empty state",u=!0):i?(u=!1,r?(s=4,n="Revamp disabled + both data sources available",l="Showing legacy widget (preferred)"):(s=6,n="Revamp disabled + only legacy data",l="Showing legacy widget (only option available)")):r?(s=5,n="Revamp disabled + only revamp data",l="Falling back to revamp widget (legacy not available)",u=!0):(s="edge-no-data",n="Revamp disabled + no data sources",l="No widget will be shown (no data available)",u=!1),{scenarioId:s,scenarioName:n,decision:l,shouldLoadRevamp:u,metadata:{productId:d,revampEnabled:c,hasLegacyData:i,hasRevampData:r}}}function W(e,t,o,c){a("[Judge.me Widget Loader] "+o+" - Scenario "+t.scenarioId+": "+t.scenarioName),a("[Judge.me Widget Loader] "+o+" - Decision:",t.decision),a("[Judge.me Widget Loader] "+o+" - Debug info:",{...t.metadata,willLoadRevamp:t.shouldLoadRevamp});let d;c===g.ALL_REVIEWS_V2025?d=window.jdgm?.data?.allReviewsWidgetV2025:d=window.jdgm?.data?.reviewWidget?.[t.metadata.productId];const i=!!d;t.metadata.hasRevampData!==i&&(console.warn("[Judge.me Widget Loader] ‚ö†Ô∏è Data mismatch detected!!"),console.warn("[Judge.me Widget Loader] Liquid says hasRevamp:",t.metadata.hasRevampData),console.warn("[Judge.me Widget Loader] JavaScript sees data:",i),console.warn("[Judge.me Widget Loader] Actual data:",d));const r=e.querySelector(".jdgm-legacy-widget-content");if(r){const s=r.innerHTML.trim().length;if(s>0&&s<=20){const n=r.innerHTML.trim().substring(0,50);a("[Judge.me Widget Loader] üìè Legacy widget is small ("+s+' chars), treating as empty. Content: "'+n+'"')}}}function E(e){const t=e.querySelector(".jdgm-legacy-widget-content");t&&(t.style.display=""),a("[Judge.me Widget Loader] ‚úÖ Legacy widget displayed")}function f(e){const t=e.dataset.entryPoint,o=e.dataset.entryKey;if(!t||!o){a("[Judge.me Widget Loader] ‚ö†Ô∏è Missing entryPoint or entryKey, skipping container");return}const c=window.jdgm.CDN_BASE_URL,d=c+t,i=e.querySelector(".jdgm-rev-widg");if(i&&(i.style.display="none",a("[Judge.me Widget Loader] üôà Hidden legacy widget element (.jdgm-rev-widg)")),a("[Judge.me Widget Loader] ‚è≥ Loading revamp widget:",t),L.has(d)||document.querySelector('script[src="'+d+'"]')){a("[Judge.me Widget Loader] ‚è≠Ô∏è Script already loaded, skipping:",t);return}L.add(d),A(c,o,t).finally(()=>{const r=document.createElement("script");r.type="module",r.src=d,r.onload=()=>{a("[Judge.me Widget Loader] ‚úÖ Revamp widget script loaded successfully:",t)},r.onerror=()=>{console.error("[Judge.me Widget Loader] ‚ùå Failed to load revamp widget script:",t)},document.head.appendChild(r)})}async function A(e,t,o){if(!(e+o).includes("localhost"))try{let l=function(u){const m=s[u];m&&(m.css&&m.css.forEach(p=>{const S=e+p;if(!document.querySelector('link[href="'+S+'"]')){const y=document.createElement("link");y.rel="stylesheet",y.href=S,document.head.appendChild(y)}}),m.imports&&m.imports.forEach(l))};var d=l;const i=e+"manifest.json?v="+Date.now(),s=await(await fetch(i)).json(),n=s[t];n&&n.css&&n.css.forEach(u=>{const m=e+u;if(!document.querySelector('link[href="'+m+'"]')){const p=document.createElement("link");p.rel="stylesheet",p.href=m,document.head.appendChild(p)}}),n&&n.imports&&n.imports.forEach(l)}catch(i){console.warn("Could not load manifest or CSS files:",i)}}w.forEach((e,t)=>{const o=D(e),c=e.dataset.entryPoint;if(a("[Judge.me Widget Loader] Processing container "+(t+1)+"/"+w.length+" - Type: "+o+", Entry: "+c),!o){a("[Judge.me Widget Loader] ‚è≠Ô∏è Unknown widget type, skipping container");return}switch(o){case g.REVIEW:{const d=v(e,"review_widget_revamp_enabled",g.REVIEW);W(e,d,"Review Widget",g.REVIEW),d.shouldLoadRevamp?f(e):E(e);break}case g.ALL_REVIEWS_V2025:{const d=v(e,"all_reviews_widget_v2025_enabled",g.ALL_REVIEWS_V2025);W(e,d,"All Reviews V2025 Widget",g.ALL_REVIEWS_V2025),d.shouldLoadRevamp?f(e):E(e);break}case g.CAROUSEL:a("[Judge.me Widget Loader] Carousel widget - always loading revamp"),f(e);break}})})();
